<h1>New Publication</h1>

<%= simple_form_for @publication, html: { class: 'needs-validation' } do |form| %>
  <% if @publication.errors.any? %>
    <div class="alert alert-danger">
      <h2><%= pluralize(@publication.errors.count, "error") %> prohibited this publication from being saved:</h2>
      <ul>
        <% @publication.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :title, class: 'form-label' %>
    <%= form.text_field :title, class: 'form-control' %>
  </div>

    <div class="mb-3">
    <%= form.label :category, class: 'form-label' %>
    <%= form.select :category, 
        Publication.categories.keys.map { |key| [key.humanize, key] }, 
        {}, class: 'form-select' %>
  </div>

  <div class="mb-3">
    <%= form.label :status, class: 'form-label' %>
    <%= form.select :status, 
        Publication.statuses.keys.map { |key| [key.humanize, key] }, 
        {}, class: 'form-select' %>
  </div>

  <div class="mb-3">
    <%= form.label :author_list, class: 'form-label' %>
    <%= form.text_area :author_list, class: 'form-control' %>
  </div>

  <div class="mb-3">
    <%= form.label :publication_date, class: 'form-label' %>
    <%= form.date_field :publication_date, class: 'form-control' %>
  </div>

  <div class="mb-3">
    <%= form.label :link, class: 'form-label' %>
    <%= form.text_field :link, class: 'form-control' %>
  </div>

  <hr>

  <h3> Research Groups Section </h3>
  <div class="research-group mb-3">
    <%= form.fields_for :research_group_publications do |rg_form| %>
      <%= render 'research_group_publication_fields', f: rg_form %>
    <% end %>
  </div>
  <%= link_to_add_association "Add Research Group", form, :research_group_publications, data: {association_insertion_node: '.research-group', association_insertion_method: :append}, class: "btn btn-secondary btn-sm" %>

  <hr>

  <h3> Identifiers Section </h3>
  <div class="identifier mb-3">
    <%= form.fields_for :identifiers do |id_form| %>
      <%= render 'identifier_fields', f: id_form %>
    <% end %>
  </div>
  <%= link_to_add_association "Add Identifier", form, :identifiers, data: {association_insertion_node: '.identifier', association_insertion_method: :append}, class: "btn btn-secondary btn-sm" %>

  <hr>

  <h3> Repository Links Section </h3>
  <div class="repository-link mb-3">
    <%= form.fields_for :repository_links do |rl_form| %>
      <%= render 'repository_link_fields', f: rl_form %>
    <% end %>
  </div>
  <%= link_to_add_association "Add Repository Link", form, :repository_links, data: {association_insertion_node: '.repository-link', association_insertion_method: :append}, class: "btn btn-secondary btn-sm" %>

  <hr>

  <h3> Conference Section </h3>
  <div class="conference" data-controller="nested-list">
    <div id="items-list">
      <%= form.association :conference, collection: Conference.all, label_method: :name, value_method: :id, include_blank: "Select a conference" %>
    </div>

    <div id="add-item-link">
      <%= link_to_add_association "Add New Conference", form, :conference, 
          data: {
            association_insertion_node: '.conference', 
            association_insertion_method: :append
          }, 
          class: "btn btn-secondary btn-sm" %>
    </div>
  </div>

  <hr>

  <h3> Journal Issue Section </h3>
  <div class="mb-3">
    <label class="form-label">Journal Issue</label>
    <div class="d-flex">
      <div class="flex-grow-1 me-2">
        <%= form.select :journal_issue_id, 
            JournalIssue.all.map { |j| [j.title, j.id] }, 
            { include_blank: "Select a journal issue" }, 
            class: 'form-select', id: 'journal-issue-select' %>
      </div>
      <button type="button" class="btn btn-primary" id="new-journal-issue-btn">Add New Journal Issue</button>
    </div>
  </div>

  <div id="new-journal-issue-fields" style="display: none;">
    <div class="card mb-3 p-3">
      <h4>New Journal Issue Details</h4>
      
      <%= form.fields_for :journal_issue, JournalIssue.new do |ji_form| %>
        <div class="mb-3">
          <%= ji_form.label :title, "Journal Issue Title", class: 'form-label' %>
          <%= ji_form.text_field :title, class: 'form-control', id: 'new-journal-issue-title', required: true %>
        </div>
        
        <div class="mb-3">
          <%= ji_form.label :journal_num, "Journal Number", class: 'form-label' %>
          <%= ji_form.text_field :journal_num, class: 'form-control' %>
        </div>
        
        <div class="mb-3">
          <%= ji_form.label :publisher, "Publisher", class: 'form-label' %>
          <%= ji_form.text_field :publisher, class: 'form-control' %>
        </div>
        
        <div class="mb-3">
          <%= ji_form.label :volume, "Volume", class: 'form-label' %>
          <%= ji_form.number_field :volume, class: 'form-control' %>
        </div>
        
        <div class="mb-3">
          <%= ji_form.label :impact_factor, "Impact Factor", class: 'form-label' %>
          <%= ji_form.number_field :impact_factor, class: 'form-control' %>
        </div>
      <% end %>
      
      <button type="button" class="btn btn-secondary" id="cancel-new-journal-issue-btn">Cancel</button>
    </div>
  </div>

  <hr>

  <h3>KPI Reporting Extension</h3>
  <div class="mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="kpi-toggle" name="create_kpi_extension">
      <label class="form-check-label" for="kpi-toggle">Add KPI Reporting Extension</label>
    </div>
  </div>

  <div id="kpi-extension-fields" style="display: none;">
    <%= form.fields_for :kpi_reporting_extension, @publication.kpi_reporting_extension || KpiReportingExtension.new do |kpi_form| %>
      <div class="mb-3">
        <%= kpi_form.label :teaming_reporting_period, "Teaming Reporting Period", class: 'form-label' %>
        <%= kpi_form.number_field :teaming_reporting_period, class: 'form-control', name: 'publication[kpi_reporting_extension_attributes][teaming_reporting_period]' %>
      </div>
      
      <div class="mb-3">
        <%= kpi_form.label :invoice_number, "Invoice Number", class: 'form-label' %>
        <%= kpi_form.number_field :invoice_number, class: 'form-control', name: 'publication[kpi_reporting_extension_attributes][invoice_number]' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :pbn, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][pbn]' %>
        <%= kpi_form.label :pbn, "PBN", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :jcr, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][jcr]' %>
        <%= kpi_form.label :jcr, "JCR", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_added_ft_portal, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_added_ft_portal]' %>
        <%= kpi_form.label :is_added_ft_portal, "Added to FT Portal", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_checked, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_checked]' %>
        <%= kpi_form.label :is_checked, "Checked", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_new_method_technique, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_new_method_technique]' %>
        <%= kpi_form.label :is_new_method_technique, "New Method/Technique", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_methodology_application, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_methodology_application]' %>
        <%= kpi_form.label :is_methodology_application, "Methodology Application", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_polish_med_researcher_involved, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_polish_med_researcher_involved]' %>
        <%= kpi_form.label :is_polish_med_researcher_involved, "Polish Medical Researcher Involved", class: 'form-check-label' %>
      </div>

      <div class="mb-3 form-check">
        <%= kpi_form.check_box :is_peer_reviewed, class: 'form-check-input', name: 'publication[kpi_reporting_extension_attributes][is_peer_reviewed]' %>
        <%= kpi_form.label :is_peer_reviewed, "Peer Reviewed", class: 'form-check-label' %>
      </div>
      
      <div class="mb-3">
        <%= kpi_form.label :subsidy_points, "Subsidy Points", class: 'form-label' %>
        <%= kpi_form.number_field :subsidy_points, class: 'form-control', name: 'publication[kpi_reporting_extension_attributes][subsidy_points]' %>
      </div>
    <% end %>
  </div>

  <hr>

  <h3>Open Access Extension</h3>
  <div class="mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="oa-toggle" name="create_open_access_extension">
      <label class="form-check-label" for="oa-toggle">Add Open Access Extension</label>
    </div>
  </div>

  <div id="open-access-extension-fields" style="display: none;">
    <%= form.fields_for :open_access_extension, @publication.open_access_extension || OpenAccessExtension.new do |oa_form| %>
      <div class="mb-3">
        <%= oa_form.label :category, "Category", class: 'form-label' %>
        <%= oa_form.select :category, 
            OpenAccessExtension.categories.keys.map { |key| [key.humanize, key] }, 
            {}, class: 'form-select', id: 'oa-category-select', name: 'publication[open_access_extension_attributes][category]' %>
      </div>
      
      <div class="mb-3 gold-oa-field" style="display: none;">
        <%= oa_form.label :gold_oa_charges, "Gold OA Charges (PLN)", class: 'form-label' %>
        <%= oa_form.number_field :gold_oa_charges, class: 'form-control', name: 'publication[open_access_extension_attributes][gold_oa_charges]' %>
      </div>
      
      <div class="mb-3 gold-oa-field" style="display: none;">
        <%= oa_form.label :gold_oa_funding_source, "Gold OA Funding Source", class: 'form-label' %>
        <%= oa_form.text_field :gold_oa_funding_source, class: 'form-control', name: 'publication[open_access_extension_attributes][gold_oa_funding_source]' %>
      </div>
    <% end %>
  </div>

  <hr>

  <div class="mb-3">
    <%= form.submit "Create Publication", class: 'btn btn-success' %>
  </div>
<% end %>

<%= link_to 'Back', publications_path, class: 'btn btn-secondary' %>

<script>
    // KPI Extension toggle functionality
    const kpiToggleElement = document.getElementById('kpi-toggle');
    if (kpiToggleElement) {
      kpiToggleElement.addEventListener('change', function() {
        const kpiFields = document.getElementById('kpi-extension-fields');
        if (kpiFields) {
          kpiFields.style.display = this.checked ? 'block' : 'none';
          
          // Clear fields when toggle is unchecked
          if (!this.checked) {
            clearInputFields(kpiFields);
          }
        }
      });
    }

    // Open Access Extension toggle functionality
    const oaToggleElement = document.getElementById('oa-toggle');
    if (oaToggleElement) {
      oaToggleElement.addEventListener('change', function() {
        const oaFields = document.getElementById('open-access-extension-fields');
        if (oaFields) {
          oaFields.style.display = this.checked ? 'block' : 'none';
          
          // Clear fields when toggle is unchecked
          if (!this.checked) {
            clearInputFields(oaFields);
            
            // Hide gold OA fields
            const goldOaFields = document.querySelectorAll('.gold-oa-field');
            goldOaFields.forEach(field => {
              field.style.display = 'none';
            });
          }
        }
      });
    }
    
    // OA Category select functionality
    const oaCategorySelect = document.getElementById('oa-category-select');
    if (oaCategorySelect) {
      oaCategorySelect.addEventListener('change', function() {
        const goldOaFields = document.querySelectorAll('.gold-oa-field');
        
        if (this.value === 'gold') {
          // Show Gold OA fields
          goldOaFields.forEach(field => {
            field.style.display = 'block';
          });
        } else {
          // Hide and clear Gold OA fields
          goldOaFields.forEach(field => {
            field.style.display = 'none';
            
            // Clear inputs within the field
            clearInputFields(field);
          });
        }
      });
      
      // Trigger change event on page load to set initial state
      oaCategorySelect.dispatchEvent(new Event('change'));
    }
</script>

