<h1 class="mb-4">Publications</h1>

<div class="row mb-2">
  <div class="col-md-3 d-flex justify-content-start gap-3 align-items-center">
    <label for="sort_select" class="form-label mb-0 text-nowrap">Sort by</label>
    <%= select_tag :sort,
        options_for_select(Publications::SortValidator.options.map { |k, _| [k.humanize, k] }, params[:sort]),
        class: "form-control",
        data: { controller: "sort", action: "change->sort#submit" } %>
  </div>
  <div class="col-md-9 d-flex justify-content-end gap-3" data-controller="toggle-search">
    <%= search_form_for @q, url: publications_path, method: :get do |f| %>
      <%= f.search_field :title_cont, class: "form-control search-field", placeholder: "Search publications by title" %>
    <% end %>
    <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#searchForm" aria-expanded="false" aria-controls="searchForm">
        Advanced Search
    </button>
  </div>
</div>

<div class="collapse" id="searchForm">
  <div class="row">
    <%= render 'search_form', query: @q %>
  </div>
</div>

<div class="row mb-0">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <%== pagy_info(@pagy) %>
    </div>

    <div class="d-flex gap-2">
      <% if user_signed_in? && current_user.moderator? %>
        <%= link_to 'Modify research groups', research_groups_path, class: "btn btn-primary" %>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to 'New Publication', new_publication_path, class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>

<div class="publication-list mt-4">
  <% @publications.each do |publication| %>
    <div class="card mb-3 shadow-sm border border-light-subtle">
      <div class="card-body">
        <h5 class="card-title text-primary-emphasis mb-2">
          <%= link_to publication.title, publication_path(publication), class: "text-decoration-none" %>
        </h5>

        <div class="d-flex flex-wrap gap-2 mb-2">
            <% status_class = case publication.status
                when "submitted" then "bg-warning text-dark"
                when "accepted"  then "bg-info text-dark"
                when "printed"   then "bg-success text-white"
                else "bg-secondary text-white"
            end %>
            <span class="badge <%= status_class %> px-2 py-1 fs-6">
                <%= publication.status.humanize %>
            </span>

            <span class="badge bg-light text-dark border px-2 py-1 fs-6">
                <%= publication.category.humanize %>
            </span>
        </div>

        <p class="mb-1 text-body-secondary">
          <strong>Authors:</strong> <%= publication.author_list %>
        </p>

        <p class="mb-1 text-body-secondary">
          <strong>Research groups:</strong> 
          <%= publication.research_group_publications.map { |rg| rg.research_group.name }.join(', ') %>
        </p>
      </div>
    </div>
  <% end %>
</div>

<div class="row">
  <div class="col-md-12 d-flex justify-content-center">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>